# üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare AI Gateway

## –ß—Ç–æ —Ç–∞–∫–æ–µ Cloudflare AI Gateway?

Cloudflare AI Gateway ‚Äî —ç—Ç–æ –ø—Ä–æ–∫—Å–∏ –º–µ–∂–¥—É –≤–∞—à–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –∏ AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ (Google, OpenAI, –∏ —Ç.–¥.), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:

- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ API
- **Rate limiting** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏

---

## üìã –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ Gateway –≤ Cloudflare Dashboard

### 1.1 –û—Ç–∫—Ä–æ–π—Ç–µ Cloudflare Dashboard

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞: https://dash.cloudflare.com
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç
3. –í –ª–µ–≤–æ–º –º–µ–Ω—é –Ω–∞–π–¥–∏—Ç–µ **"AI"** ‚Üí **"AI Gateway"**

### 1.2 –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π Gateway

1. –ù–∞–∂–º–∏—Ç–µ **"Create Gateway"**
2. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: `webapp-gateway` (–∏–ª–∏ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ)
3. –ù–∞–∂–º–∏—Ç–µ **"Create"**

### 1.3 –°–∫–æ–ø–∏—Ä—É–π—Ç–µ Gateway URL

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã —É–≤–∏–¥–∏—Ç–µ URL –≤–∏–¥–∞:
```
https://gateway.ai.cloudflare.com/v1/{account_id}/{gateway_id}/google-ai-studio/v1beta/models/gemini-1.5-flash:generateContent
```

**–í–∞–∂–Ω–æ:** –ó–∞–º–µ–Ω–∏—Ç–µ `gemini-1.5-flash` –Ω–∞ `gemini-2.5-flash-image` –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ IMAGE –º–æ–¥–µ–ª—å.

---

## üìã –®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ Gateway Token

### 2.1 –°–æ–∑–¥–∞–π—Ç–µ API Token

1. –í Cloudflare Dashboard –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **"My Profile"** ‚Üí **"API Tokens"**
2. –ù–∞–∂–º–∏—Ç–µ **"Create Token"**
3. –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω **"Edit Cloudflare Workers"** –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ custom token

### 2.2 –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–∫–µ–Ω–∞

**Permissions:**
- Account ‚Üí Cloudflare AI ‚Üí Read
- Account ‚Üí Cloudflare AI ‚Üí Edit

**Account Resources:**
- Include ‚Üí Your Account

### 2.3 –°–æ–∑–¥–∞–π—Ç–µ –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω

1. –ù–∞–∂–º–∏—Ç–µ **"Continue to summary"**
2. –ù–∞–∂–º–∏—Ç–µ **"Create Token"**
3. **–í–ê–ñ–ù–û:** –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω —Å—Ä–∞–∑—É (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑!)

---

## üìã –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### 3.1 –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.dev.vars`

```bash
cd /home/user/webapp
cp .dev.vars.example .dev.vars
```

### 3.2 –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.dev.vars`

```bash
# Cloudflare AI Gateway Configuration

# Gateway URL (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à)
GATEWAY_URL=https://gateway.ai.cloudflare.com/v1/YOUR_ACCOUNT_ID/webapp-gateway/google-ai-studio/v1beta/models/gemini-2.5-flash-image:generateContent

# Gateway Token (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à)
GATEWAY_TOKEN=your_actual_token_here
```

**–ì–¥–µ –Ω–∞–π—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è:**
- `YOUR_ACCOUNT_ID`: –≤ URL Cloudflare Dashboard –∏–ª–∏ –≤ Settings ‚Üí Account ID
- `webapp-gateway`: –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ Gateway
- `your_actual_token_here`: —Ç–æ–∫–µ–Ω –∏–∑ —à–∞–≥–∞ 2.3

---

## üìã –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ

### 4.1 –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç

```bash
cd /home/user/webapp
npm run build
```

### 4.2 –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π
pm2 delete webapp 2>/dev/null || true

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–π
pm2 start ecosystem.config.cjs
```

### 4.3 –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

```bash
pm2 logs webapp --nostream
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
Step 1: Describing outfit from PHOTO B...
Step 2: Generating virtual try-on image...
```

### 4.4 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ: http://localhost:3000
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
3. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–∑"
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

---

## üìã –®–∞–≥ 5: Deployment –Ω–∞ Cloudflare Pages

### 5.1 –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# GATEWAY_URL
npx wrangler pages secret put GATEWAY_URL --project-name webapp
# –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à Gateway URL

# GATEWAY_TOKEN
npx wrangler pages secret put GATEWAY_TOKEN --project-name webapp
# –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω
```

### 5.2 –î–µ–ø–ª–æ–π

```bash
npm run build
npx wrangler pages deploy dist --project-name webapp
```

### 5.3 –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –æ—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à URL –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ:
```
https://webapp.pages.dev
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Gateway

### –ß–µ—Ä–µ–∑ Cloudflare Dashboard:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **AI Gateway** ‚Üí **webapp-gateway**
2. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É **"Analytics"**
3. –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞
   - –û—à–∏–±–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

### –ß–µ—Ä–µ–∑ –ª–æ–≥–∏ (–ª–æ–∫–∞–ª—å–Ω–æ):

```bash
pm2 logs webapp --nostream
```

–ò—â–∏—Ç–µ:
```
Step 1: Describing outfit from PHOTO B...
Extracted outfit description: {"garment_type": "..."}
Step 2: Generating virtual try-on image...
```

---

## ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: "Gateway –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

**–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ GATEWAY_URL –∏–ª–∏ GATEWAY_TOKEN

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .dev.vars
cat .dev.vars

# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –ø—É—Å—Ç—ã–µ
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: "Unauthorized" –∏–ª–∏ 401

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π GATEWAY_TOKEN

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –≤ Cloudflare Dashboard
- –û–±–Ω–æ–≤–∏—Ç–µ GATEWAY_TOKEN –≤ .dev.vars
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

### –ü—Ä–æ–±–ª–µ–º–∞ 3: "Model not found"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π URL –º–æ–¥–µ–ª–∏ –≤ GATEWAY_URL

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ `gemini-2.5-flash-image` (–Ω–µ `gemini-1.5-flash`)
- –§–æ—Ä–º–∞—Ç: `.../google-ai-studio/v1beta/models/gemini-2.5-flash-image:generateContent`

### –ü—Ä–æ–±–ª–µ–º–∞ 4: "Step 1 error" –∏–ª–∏ "Step 2 error"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º–∞ —Å Gateway –∏–ª–∏ –º–æ–¥–µ–ª—å—é

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
pm2 logs webapp

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Gateway –≤ Dashboard
# Cloudflare Dashboard ‚Üí AI Gateway ‚Üí Analytics
```

---

## üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Gateway

### –≠–∫–æ–Ω–æ–º–∏—è:

–ï—Å–ª–∏ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å –¥–µ–ª–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑:
- **–ë–µ–∑ Gateway:** –∫–∞–∂–¥—ã–π —Ä–∞–∑ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ Google ‚Üí –æ–ø–ª–∞—Ç–∞ –∫–∞–∂–¥—ã–π —Ä–∞–∑
- **–° Gateway:** –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –∫ Google, –¥–∞–ª—å—à–µ –∏–∑ –∫—ç—à–∞ ‚Üí –æ–ø–ª–∞—Ç–∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑

**–ü—Ä–∏–º–µ—Ä:**
- 100 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ë–µ–∑ Gateway: 100 √ó $0.0005 = **$0.05**
- –° Gateway (–∫—ç—à 24—á): 1 √ó $0.0005 = **$0.0005** (—ç–∫–æ–Ω–æ–º–∏—è 99%)

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

–í Dashboard Gateway –≤–∏–¥–Ω–æ:
- –°–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å/–Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü
- –ö–∞–∫–∏–µ –º–æ–¥–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
- –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –∫–∞–∂–¥–∞—è –º–æ–¥–µ–ª—å
- Hit rate –∫—ç—à–∞
- –°—Ä–µ–¥–Ω—è—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

### Rate Limiting:

–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏–º–∏—Ç—ã:
- –ú–∞–∫—Å–∏–º—É–º X –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
- –ú–∞–∫—Å–∏–º—É–º Y –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è

---

## üéØ –ò—Ç–æ–≥–æ

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É –≤–∞—Å –±—É–¥–µ—Ç:

‚úÖ Cloudflare AI Gateway –Ω–∞—Å—Ç—Ä–æ–µ–Ω  
‚úÖ –î–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–æ–ø–∏—Å–∞–Ω–∏–µ ‚Üí try-on)  
‚úÖ –ü—Ä–æ–º–ø—Ç –∫–∞–∫ –≤ –≤–∏–¥–µ–æ (PHOTO A, PHOTO B, JSON description)  
‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤  
‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è  
‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤  

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Cloudflare Pages ‚Üí Cloudflare AI Gateway ‚Üí Google Gemini
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- **Cloudflare AI Gateway Docs:** https://developers.cloudflare.com/ai-gateway/
- **Gemini API Docs:** https://ai.google.dev/gemini-api/docs
- **Wrangler Docs:** https://developers.cloudflare.com/workers/wrangler/

---

**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–î–∞—Ç–∞:** 2026-02-04  
**–°—Ç–∞—Ç—É—Å:** Ready for production
