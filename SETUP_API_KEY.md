# Настройка Replicate API для Virtual Try-On

## Шаг 1: Получение API ключа

1. Перейдите на https://replicate.com/
2. Зарегистрируйтесь или войдите в аккаунт
3. Перейдите в раздел API tokens: https://replicate.com/account/api-tokens
4. Нажмите "Create token"
5. Скопируйте созданный токен (начинается с `r8_`)

**Бесплатный tier:**
- $5 кредитов при регистрации
- IDM-VTON стоит ~$0.01-0.05 за генерацию
- Это примерно 100-500 бесплатных генераций

## Шаг 2: Настройка для локальной разработки

1. Скопируйте файл `.dev.vars.example` в `.dev.vars`:
   ```bash
   cp .dev.vars.example .dev.vars
   ```

2. Откройте `.dev.vars` и вставьте ваш API токен:
   ```
   REPLICATE_API_TOKEN=r8_your_actual_token_here
   ```

3. Перезапустите сервер:
   ```bash
   npm run clean-port
   pm2 restart webapp
   ```

## Шаг 3: Настройка для Cloudflare Pages

После деплоя на Cloudflare Pages, установите секрет:

```bash
npx wrangler pages secret put REPLICATE_API_TOKEN --project-name webapp
```

Введите ваш API токен когда система попросит.

## Проверка

Откройте приложение и попробуйте загрузить два изображения. 

Если API токен настроен правильно:
- Обработка займет 20-40 секунд
- Вы увидите реальный результат виртуальной примерки

Если видите ошибку "API ключ не настроен", проверьте:
1. Файл `.dev.vars` существует и содержит правильный токен
2. Токен начинается с `r8_`
3. Вы перезапустили сервер после изменения `.dev.vars`
4. В Cloudflare Pages секрет установлен командой выше

## Используемая модель

**IDM-VTON (Improved Diffusion Models for Virtual Try-On)**
- Специализированная модель для виртуальной примерки одежды
- Сохраняет позу, лицо и фон человека
- Применяет одежду естественным образом
- Высокое качество результатов

**Параметры генерации:**
- `n_samples`: 1 (количество вариантов)
- `n_steps`: 20 (шагов диффузии, больше = качественнее но медленнее)
- `image_scale`: 768 (разрешение)
- `seed`: -1 (случайный seed для разнообразия)

## Лимиты API

**Free tier:**
- $5 бесплатных кредитов
- После использования - платно
- Цена: ~$0.01-0.05 за генерацию

**Платные планы:**
- Pay-as-you-go (платите только за использование)
- Нет месячных подписок
- Прозрачное ценообразование

## Альтернативы

Если не хотите использовать Replicate, можно попробовать:

1. **Hugging Face Inference API** (бесплатно, медленнее)
2. **Своя модель на GPU** (требует инфраструктуру)
3. **Другие Virtual Try-On сервисы**

## Поддержка

Если возникли проблемы:
- Проверьте баланс на https://replicate.com/account/billing
- Посмотрите логи: `pm2 logs webapp --nostream`
- Проверьте статус Replicate: https://status.replicate.com/
