# Обработка ошибок в Virtual Try-On

## Общая информация

Приложение Virtual Try-On имеет комплексную систему обработки ошибок, которая помогает пользователям понять, что пошло не так, и как решить проблему.

---

## Типы ошибок и как их определить

### 1. **Идентичное изображение (Same Image)**

**Как определяется:**
- Backend сравнивает первые 100 символов base64 входного фото и результата
- Если они идентичны — значит AI просто вернул то же изображение

**Когда возникает:**
- AI не смог обработать запрос корректно
- Изображения низкого качества
- Нечёткая одежда на фото
- Слишком сложная задача для AI

**Сообщение пользователю:**
```
Результат идентичен входному изображению

AI не смог обработать изображения корректно. 
Попробуйте другие фото или повторите позже.
```

**Решение:**
- Загрузите другие фотографии
- Убедитесь, что одежда хорошо видна
- Используйте фото с хорошим освещением
- Попробуйте ещё раз через несколько минут

---

### 2. **Фильтр безопасности (Safety Filter)**

**Как определяется:**
- Gemini API возвращает `finishReason: "SAFETY"` или `"BLOCKED_REASON"`
- Это означает, что контент не прошёл проверку безопасности

**Когда возникает:**
- Неподходящий контент на изображениях
- Откровенная одежда
- Нарушение политики использования

**Сообщение пользователю:**
```
Контент заблокирован

Изображения не прошли проверку безопасности. 
Попробуйте другие фото.

Советы:
• Используйте качественные фотографии
• Избегайте неподходящего контента
• Попробуйте другие изображения
```

**Решение:**
- Используйте другие, подходящие изображения
- Проверьте содержание фото
- Убедитесь, что фото соответствуют правилам

---

### 3. **Ошибки API генерации**

**Как определяется:**
- API возвращает `error` в ответе
- HTTP статус 500 от Gemini API

**Когда возникает:**
- Превышен лимит запросов (Rate Limit)
- Проблемы на стороне Google API
- Недоступность сервиса
- Неправильный API ключ

**Сообщение пользователю:**
```
Ошибка API генерации изображений

Сервис временно недоступен. Попробуйте позже.
```

**Решение:**
- Подождите несколько минут и попробуйте снова
- Проверьте лимиты API (15 req/min, 1500 req/day)
- Убедитесь, что API ключ активен

---

### 4. **Слишком большие изображения**

**Как определяется:**
- `Maximum call stack size exceeded` ошибка
- Превышение лимита памяти при конвертации

**Когда возникает:**
- Изображения > 2-3 MB
- Очень высокое разрешение (> 4K)
- Недостаточно памяти для обработки

**Сообщение пользователю:**
```
Изображения слишком большие. 
Попробуйте меньшего размера (до 2MB).

Советы:
• Сожмите изображения перед загрузкой
• Рекомендуемый размер: до 2MB
• Используйте онлайн-компрессоры
```

**Решение:**
- Сжать изображения перед загрузкой
- Использовать онлайн-компрессоры (TinyPNG, Squoosh)
- Конвертировать в формат JPEG
- Уменьшить разрешение до 1920x1080

---

### 5. **Ошибки сети (Network Errors)**

**Как определяется:**
- Ошибки `fetch failed`
- Timeout ошибки
- Нет подключения к API

**Когда возникает:**
- Нет интернета
- Проблемы с сетью
- Блокировка запросов
- Timeout запроса

**Сообщение пользователю:**
```
Не удалось подключиться к сервису AI. 
Проверьте подключение.
```

**Решение:**
- Проверить интернет-соединение
- Попробовать перезагрузить страницу
- Использовать VPN если заблокирован доступ

---

## Архитектура обработки ошибок

### Backend (src/index.tsx)

```typescript
// 1. Проверка API ключа
if (!apiKey) {
  return c.json({ 
    error: 'API ключ не настроен',
    message: '...'
  }, 500)
}

// 2. Обработка ответа API
const data = await response.json()

// 3. Проверка на ошибки API
if (data.error) {
  return c.json({ 
    error: 'Ошибка API',
    message: 'Сервис временно недоступен',
    details: data.error 
  }, 500)
}

// 4. Проверка фильтров безопасности
if (reason === 'SAFETY') {
  return c.json({ 
    error: 'Контент заблокирован',
    message: 'Изображения не прошли проверку безопасности'
  }, 400)
}

// 5. Проверка на идентичное изображение
if (inputPhotoHash === outputHash) {
  return c.json({
    error: 'Результат идентичен входному',
    message: 'AI не смог обработать изображения корректно',
    warning: 'same_as_input'
  }, 400)
}

// 6. Общий catch для неожиданных ошибок
catch (error) {
  return c.json({ 
    error: 'Ошибка обработки',
    message: userMessage,
    support: 'Если проблема повторяется...'
  }, 500)
}
```

### Frontend (public/static/app.js)

```javascript
// 1. Проверка ответа
if (!response.ok) {
  const errorMsg = data.message || data.error || 'Ошибка...';
  throw new Error(errorMsg);
}

// 2. Проверка формата изображения
if (!data.image.startsWith('data:image/')) {
  throw new Error('Получен некорректный формат изображения');
}

// 3. Специальная обработка для идентичных изображений
if (data.warning === 'same_as_input') {
  throw new Error('AI вернул то же изображение. Попробуйте другие фото.');
}

// 4. Добавление полезных советов
if (errorMsg.includes('одинаковые')) {
  errorMsg += '\n\nСоветы:\n• Попробуйте другие фотографии...';
}
```

---

## UI/UX для ошибок

### Стилизация error-message

```css
.error-message {
  margin-top: 2rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
  border: 2px solid #fc8181;
  border-radius: 1rem;
  color: #c53030;
  text-align: left;
  line-height: 1.6;
  box-shadow: 0 4px 15px rgba(252, 129, 129, 0.2);
  animation: slideIn 0.3s ease-out;
}
```

### Поведение

1. **Показ ошибки:**
   - Анимация появления (slideIn)
   - Автопрокрутка к сообщению об ошибке
   - Поддержка многострочного текста с советами

2. **Автоматическое скрытие:**
   - Через 10 секунд (для длинных сообщений)
   - Пользователь может вручную закрыть
   - Скрывается при новой попытке генерации

3. **Визуальные подсказки:**
   - Красный градиентный фон
   - Иконка ошибки (можно добавить)
   - Чёткий контраст для читаемости

---

## Тестирование обработки ошибок

### Как проверить каждый тип ошибки:

**1. Идентичное изображение:**
- Сложно воспроизвести напрямую
- Зависит от реакции AI
- Можно проверить логику сравнения в коде

**2. Фильтр безопасности:**
- Загрузить неподходящий контент
- Проверить откровенную одежду
- Тестировать на граничных случаях

**3. Ошибка API:**
- Использовать неверный API ключ
- Превысить лимит запросов
- Отключить интернет

**4. Большие изображения:**
- Загрузить фото > 5MB
- Использовать 4K+ разрешение
- Тестировать на разных размерах

**5. Ошибка сети:**
- Отключить интернет
- Использовать медленное соединение
- Симулировать timeout

---

## Лучшие практики

### Для разработчиков:

1. **Всегда логируйте ошибки:**
   ```javascript
   console.error('Try-on error:', error)
   ```

2. **Предоставляйте контекст:**
   ```javascript
   return c.json({ 
     error: 'Краткое описание',
     message: 'Подробное объяснение',
     details: technicalDetails,
     support: 'Что делать дальше'
   })
   ```

3. **Тестируйте все сценарии:**
   - Успешная генерация
   - Все типы ошибок
   - Граничные случаи

### Для пользователей:

1. **Используйте качественные фото:**
   - Хорошее освещение
   - Чёткое изображение
   - Простой фон

2. **Оптимизируйте размер:**
   - До 2MB
   - Разрешение 1920x1080 или меньше
   - Формат JPEG

3. **При ошибках:**
   - Прочитайте сообщение
   - Следуйте советам
   - Попробуйте другие фото
   - Подождите несколько минут

---

## Мониторинг и логирование

### Production (Cloudflare Pages):

1. **Cloudflare Analytics:**
   - Количество ошибок
   - Типы ошибок
   - Время ответа

2. **Real User Monitoring:**
   - Отслеживание пользовательского опыта
   - Ошибки в браузере
   - Производительность

3. **Logs:**
   ```bash
   # Просмотр логов в production
   npx wrangler tail webapp
   ```

### Development (Sandbox):

```bash
# Просмотр логов
pm2 logs webapp --nostream

# Мониторинг в реальном времени
pm2 logs webapp

# Статус сервиса
pm2 list
```

---

## Roadmap улучшений

### Краткосрочные (1-2 недели):

- [ ] Добавить retry механизм для временных ошибок
- [ ] Улучшить алгоритм определения идентичных изображений
- [ ] Добавить предварительное сжатие изображений на клиенте

### Среднесрочные (1-2 месяца):

- [ ] Интегрировать Sentry для отслеживания ошибок
- [ ] Добавить метрики производительности
- [ ] Реализовать очередь запросов при превышении лимитов

### Долгосрочные (3+ месяца):

- [ ] Машинное обучение для предсказания типа ошибки
- [ ] Автоматическое исправление проблемных изображений
- [ ] A/B тестирование различных сообщений об ошибках

---

## Полезные ссылки

- [Gemini API Documentation](https://ai.google.dev/gemini-api/docs)
- [Cloudflare Workers Error Handling](https://developers.cloudflare.com/workers/platform/limits/)
- [MDN: Handling Errors](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Control_flow_and_error_handling)

---

**Последнее обновление:** 2026-02-04  
**Версия:** 1.0.0  
**Статус:** Активная разработка
